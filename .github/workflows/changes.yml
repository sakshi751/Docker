name: Changes

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest  # windows-latest | macos-latest
    name: Test changed file
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # OR "2" -> To retrieve the preceding commit.

      # Example 1
      - name: Create Token
        id: myRequest
        run: |
          curl -x POST https://980934bbtrial.authentication.us10.hana.ondemand.com/oauth/token?grant_type=client_credentials \ 
           -H "Accept: application/json" \     
           -u " sb-171d2491-9b93-4eae-abe6-6b88d8fc3060!b143373|cas-uaa-prod!b6249 : vXuyMj14JOBq33lgp6XvYbG1uKo= " \     
           -d "grant_type=client_credentials"

      - name: Show Token
        run: |
          echo ${{ steps.myRequest.outputs.response }}
      
      - name: GET CALL USING CURL
        id: getCallUsingCURL
        run: |   
          curl --request GET \
          --header 'authorization: Bearer ${{ fromJson(steps.myRequest.outputs.response).access_token }}' \
          --header 'content-type: application/json' \
          --url https://content-agent-engine.cfapps.us10.hana.ondemand.com/v1/contentResources?grant_type=client_credentials
      - name: get changed files
        id: getfile
        run: |
          echo "files=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | xargs)" >> $GITHUB_OUTPUT
      - name: echo output
        run: |
            echo ${{ steps.getfile.outputs.files }}
      - name: check split
        run: |
          MYPATH=${{ steps.getfile.outputs.files }}
          echo $MYPATH
          MYFILE=${MYPATH##*/}
          echo $MYFILE
          MYSAMPLE=${MYFILE%.*}
          echo $MYSAMPLE
      - name: run collection
        uses: docker-practice/actions-setup-docker@master
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - run: |
          MYPATH=${{ steps.getfile.outputs.files }}
          MYFILE=${MYPATH##*/}
          MYSAMPLE=${MYFILE%.*}
          docker run -v $PWD:/etc/newman -t postman/newman run "test/$MYSAMPLE.json"
